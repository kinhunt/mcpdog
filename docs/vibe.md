# MCPDog 项目架构与工作指南

## 1. 项目概览

MCPDog 是一个通用的 MCP (Model Context Protocol) 服务器管理器，旨在简化 MCP 服务的发现、管理和集成。它充当一个中间层，统一管理多个下游 MCP 服务器，并为 MCP 客户端提供统一的工具接口。

**核心功能:**
*   **多协议支持:** 通过不同的适配器支持多种 MCP 传输协议 (stdio, HTTP-SSE, Streamable HTTP)。
*   **统一工具路由:** 将来自不同 MCP 服务器的工具聚合到一个统一的工具列表中，并处理工具名称冲突。
*   **配置管理:** 集中管理 MCP 服务器配置，支持动态加载、保存和监视配置更改。
*   **CLI 界面:** 提供丰富的命令行工具，用于服务器管理、协议检测、配置优化和诊断。
*   **健壮性与恢复:** 内置进程崩溃检测、黑名单和智能重连机制，确保服务的稳定性和可用性。
*   **Web 界面 (待实现/实验性):** 计划提供一个 Web UI 进行管理。

## 2. 核心组件架构

MCPDog 的架构围绕以下几个核心组件构建：

### 2.1. `src/index.ts` (主入口)
*   **职责:** MCPDog 在标准 I/O (stdio) 模式下的主要入口点。
*   **工作方式:** 负责解析命令行参数、加载配置，并初始化 `MCPDogServer`。它通过 stdio 接收 MCP 客户端请求，并将响应发送回客户端。

### 2.2. `src/core/mcpdog-server.ts` (核心服务器逻辑)
*   **职责:** MCPDog 的核心业务逻辑，管理整个 MCP 服务生命周期。
*   **工作方式:**
    *   管理服务器的启动和停止。
    *   与 `ConfigManager` 交互，加载、监视并响应配置更改。
    *   利用 `ToolRouter` 管理并将请求路由到各种 MCP 服务适配器。
    *   使用 `AdapterFactory` 创建和管理 `ServerAdapter` 实例。
    *   处理 MCP 协议请求 (initialize, tools/list, tools/call 等)。
    *   当工具列表发生变化时，向连接的客户端发送通知。
    *   实现请求去重和错误处理。

### 2.3. `src/config/config-manager.ts` (配置管理器)
*   **职责:** 负责 MCPDog 配置的加载、保存、验证和动态管理。
*   **工作方式:**
    *   读取和写入 `mcpdog.config.json` 文件。
    *   监视配置文件更改并自动重新加载。
    *   提供添加、更新、删除和切换单个 MCP 服务器配置的方法。
    *   集成 `AutoConfigGenerator` 进行自动配置建议。
    *   集成 `ProtocolDetector` 进行协议检测。
    *   提供配置验证和优化功能。
    *   发出配置相关的事件。

### 2.4. `src/router/tool-router.ts` (工具路由器)
*   **职责:** 管理和路由来自各种 MCP 服务器的工具。
*   **工作方式:**
    *   管理 `ServerAdapter` 实例。
    *   从连接的适配器获取工具，并维护工具名称到适配器的映射。
    *   处理工具名称冲突 (通过添加服务器名称前缀)。
    *   将 `tools/call` 请求路由到正确的适配器并调用工具。
    *   管理适配器的连接和断开，支持并发连接和超时。
    *   提供服务器健康监控和自动修复功能。
    *   发出工具相关的事件。

### 2.5. `src/adapters/` (适配器层)
*   **职责:** 抽象不同 MCP 传输协议的通信细节。
*   **`adapter-factory.ts`:**
    *   **职责:** 根据配置的传输类型创建和验证 `ServerAdapter` 实例。
    *   **工作方式:** 充当工厂模式，实例化 `StdioAdapter`、`HttpSseAdapter` 或 `StreamableHttpAdapter`。包含详细的配置验证逻辑，包括敏感环境变量的安全检查。
*   **`stdio-adapter.ts`:**
    *   **职责:** 通过标准输入/输出 (stdio) 与 MCP 服务器通信。
    *   **工作方式:** 生成并管理子进程，处理其 I/O。内置健壮的崩溃检测、黑名单和智能重连机制。
*   **`http-sse-adapter.ts`:**
    *   **职责:** 通过 HTTP 和服务器发送事件 (SSE) 与 MCP 服务器通信。
    *   **工作方式:** 使用 `axios` 发送 HTTP 请求，使用 `eventsource` 建立 SSE 连接以接收实时通知。支持动态端点和会话管理，并处理连接丢失后的自动重连。
*   **`streamable-http-adapter.ts`:**
    *   **职责:** 通过“可流式 HTTP”协议与 MCP 服务器通信 (结合了标准 HTTP 请求和流式响应)。
    *   **工作方式:** 使用 `axios` 发送 HTTP 请求，并能够解析 HTTP 响应正文中的 SSE 样流。支持会话管理。

### 2.6. `src/cli/` (命令行界面)
*   **职责:** 提供用户友好的命令行接口来管理 MCPDog。
*   **`cli-main.ts`:**
    *   **职责:** CLI 的主入口点。
    *   **工作方式:** 解析命令行参数，设置 CLI 环境，并将命令分派给 `CLICommandRouter`。
*   **`cli-router.ts`:**
    *   **职责:** CLI 命令的中央调度器。
    *   **工作方式:** 实例化各种命令处理器 (如 `ConfigCommands`, `DetectCommands` 等)，并根据用户输入的命令执行相应的方法。
*   **`cli-utils.ts`:**
    *   **职责:** 提供通用的 CLI 实用函数。
    *   **工作方式:** 处理日志记录、彩色输出、JSON 输出、版本显示、全局帮助、表格打印、进度条和用户确认等。
*   **`src/cli/commands/` (命令实现):**
    *   **职责:** 实现具体的 CLI 命令逻辑 (例如 `config`, `detect`, `optimize`, `diagnose`, `audit`, `proxy`, `start`, `daemon`)。
    *   **工作方式:** 每个文件负责一个或多个子命令，与 `ConfigManager` 和 `CLIUtils` 交互以执行其任务。

## 3. 后续工作指导

### 3.1. 代码规范与风格
*   **保持一致性:** 在修改或添加代码时，请严格遵循现有代码库的编码风格、命名约定和文件结构。
*   **TypeScript 最佳实践:** 充分利用 TypeScript 的类型系统，确保代码的类型安全和可维护性。
*   **注释:** 仅在必要时添加注释，解释“为什么”这样做，而不是“做什么”。避免冗余注释。

### 3.2. 模块化与职责分离
*   **单一职责原则:** 确保每个模块和函数都只负责一项明确的任务。
*   **低耦合高内聚:** 模块之间应尽可能独立，减少相互依赖。

### 3.3. 错误处理与日志
*   **健壮的错误处理:** 确保所有可能出错的操作都有适当的错误处理机制。
*   **统一日志:** 使用 `globalLogManager` 或 `CLIUtils` 进行日志记录，保持日志的一致性和可追溯性。

### 3.4. 测试
*   **单元测试:** 为核心逻辑和复杂功能编写单元测试。
*   **集成测试:** 为不同组件之间的交互编写集成测试。
*   **E2E 测试:** 确保端到端的功能正常工作。

### 3.5. 性能优化
*   **异步操作:** 充分利用异步编程模型，避免阻塞主线程。
*   **资源管理:** 确保正确释放资源 (例如，关闭文件句柄、终止子进程)。

## 4. 关键要求: 中文内容英文化

**重要提示:** 为了提高项目的国际化程度和可维护性，所有代码中的中文注释以及与用户交互相关的中文内容（包括 CLI 输出、错误消息、提示等）都必须翻译成英文。

**执行步骤:**
1.  **识别:** 仔细审查所有 `.ts`, `.js`, `.json`, `.md` 文件，识别其中的中文文本。
2.  **翻译:** 将识别到的中文文本准确、地道地翻译成英文。
3.  **替换:** 使用 `replace` 工具或手动编辑，将中文内容替换为英文。
4.  **验证:** 确保翻译后的内容在语法、语义和上下文上都是正确的，并且没有引入新的错误。

**示例:**
*   **注释:** `// 这是一个中文注释` -> `// This is a Chinese comment`
*   **CLI 输出:** `CLIUtils.info('没有配置任何服务器');` -> `CLIUtils.info('No servers configured');`
*   **错误消息:** `throw new Error('添加服务器失败');` -> `throw new Error('Failed to add server');`
*   **用户提示:** `CLIUtils.confirm('确定要删除服务器吗?');` -> `CLIUtils.confirm('Are you sure you want to remove the server?');`

请确保在整个代码库中保持翻译的一致性。

---

**GEMINI.md** 生成完毕。现在，我将开始第二阶段的工作：将所有代码注释以及与用户交互相关的中文内容全部翻译成英文。

我将从 `src/` 目录开始，并使用 `glob` 来查找所有相关的 `.ts` 文件。
